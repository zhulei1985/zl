HashMap mapAccount = nullptr;
CArray ConnectorArray = nullptr;
void InitConnector(Connector pConnector)
{
	//pConnector->SetHeadProtocol("inner","server","123456");
	pConnector->SetScriptLimit("Error_CannotRunScript",1);
	//pConnector->SetScriptLimit("RegisterAccount",1);
	//pConnector->SetScriptLimit("LoginAccount",1);
	pConnector->SetRouteInitScript("InitRouteConnector");
}
void InitRouteConnector(Connector pConnector)
{
	print("³õÊ¼»¯Â·ÓÉÁ¬½Ó");
	//pConnector->SetHeadProtocol("inner","server","123456");
	pConnector->SetScriptLimit("Error_CannotRunScript",1);
	pConnector->SetScriptLimit("RegisterAccount",1);
	pConnector->SetScriptLimit("LoginAccount",1);
}
void RegisterAccount(string strAccount, string password, Connector pConnector)
{
	print("³¢ÊÔ×¢²áÕËºÅ:"+strAccount+" "+password);
	CAccount pAccount = mapAccount->GetVal(strAccount);
	if (CheckClassPoint(pAccount))
	{
		//ÕËºÅÒÑ´æÔÚ£¬×¢²áÊ§°Ü
		pConnector->RunScript(0,"RegisterFail",pAccount);
		return;
	}
	print("×¢²á----1");
	pAccount = new CAccount;
	pAccount->SetAccountName(strAccount);
	pAccount->SetPassword(password);
	pAccount->SetNickName(strAccount);
	print("×¢²á----2");
	pAccount->SetVal("connect",pConnector);
	pConnector->SetVal("account",pAccount);
	mapAccount->SetVal(strAccount,pAccount);
	//·¢ËÍ×¢²á³É¹¦£¬µÇÂ¼³É¹¦
	pConnector->RunScript(0,"LoginSuccess",pAccount);
	pConnector->SetScriptLimit("Talk",1);
	ConnectorArray->Add(pConnector);
	print("×¢²á----Íê³É");
}
void LoginAccount(string strAccount, string password, Connector pConnector)
{
	print("³¢ÊÔµÇÂ¼ÕËºÅ:"+strAccount+" "+password);
	CAccount pAccount = mapAccount->GetVal(strAccount);
	if (0 == CheckClassPoint(pAccount))
	{
		//ÕËºÅ²»´æÔÚ£¬µÇÂ¼Ê§°Ü
		pConnector->RunScript(0,"LoginFail",pAccount,1);
		return;
	}
	if (password != pAccount->GetPassword())
	{
		//ÃÜÂë´íÎó£¬µÇÂ¼Ê§°Ü
		pConnector->RunScript(0,"LoginFail",pAccount,2);
		return;
	}

	pAccount->SetVal("connect",pConnector);
	pConnector->SetVal("account",pAccount);
	mapAccount->SetVal(strAccount,pAccount);
	pConnector->RunScript(0,"LoginSuccess",pAccount);
	pConnector->SetScriptLimit("Talk",1);
	ConnectorArray->Add(pConnector);
}

void Talk(string strContent, Connector pConnector)
{

	if (strContent != "")
	{

		CAccount pMainAccount = pConnector->GetVal("account");
		int i = 0;
		while (i < ConnectorArray->GetSize())
		{
			Connector pAccClient = ConnectorArray->Get(i);

			if (CheckClassPoint(pAccClient))
			{
				pAccClient->RunScript(0,"SendMessage",pMainAccount,strContent);
			}
		
			i = i + 1;
		}
		
	}
}
void main()
{
	//³õÊ¼»¯Êý¾Ý
	InitData("Data");
	mapAccount = new HashMap;
	ConnectorArray = new CArray;
	SetListenPort(9999,"inner","123456","InitConnector");
	print("Æô¶¯Íê³É");
}