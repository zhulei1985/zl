void InitConnector(Connector pConnector)
{
	pConnector->SetHeadProtocol("inner","server","123456");
	pConnector->SetScriptLimit("Error_CannotRunScript",1);
	pConnector->SetScriptLimit("RegisterAccount",1);
	pConnector->SetScriptLimit("LoginAccount",1);
}
void RegisterAccount(string strAccount, string password, Connector pConnector)
{
	print("³¢ÊÔ×¢²áÕËºÅ:"+strAccount+" "+password);
	CArray AccountArray = GetVal4Data("Data","Account");
	if (CheckClassPoint(AccountArray) == 0)
	{
		AccountArray = NewArray();
		SetVal2Data("Data","Account",AccountArray);
	}
	CAccount pAccount = AccountArray->GetVal(strAccount);
	if (CheckClassPoint(pAccount))
	{
		//ÕËºÅÒÑ´æÔÚ£¬×¢²áÊ§°Ü
		pConnector->RunScript(0,"RegisterFail",pAccount);
		return;
	}
	pAccount = new CAccount;
	pAccount->SetAccountName(strAccount);
	pAccount->SetPassword(password);
	pAccount->SetNickName(strAccount);

	pAccount->SetConnect(pConnector);
	pConnector->SetAccount(strAccount);
	AccountArray->SetVal(strAccount,pAccount);
	//·¢ËÍ×¢²á³É¹¦£¬µÇÂ¼³É¹¦
	pConnector->RunScript(0,"LoginSuccess",pAccount);
	pConnector->SetScriptLimit("Talk",1);
}
void LoginAccount(string strAccount, string password, Connector pConnector)
{
	print("³¢ÊÔµÇÂ¼ÕËºÅ:"+strAccount+" "+password);
	CArray AccountArray = GetVal4Data("Data","Account");
	if (0 == CheckClassPoint(AccountArray))
	{
		AccountArray = NewArray();
		SetVal2Data("Data","Account",AccountArray);
	}
	CAccount pAccount = AccountArray->GetVal(strAccount);
	if (0 == CheckClassPoint(pAccount))
	{
		//ÕËºÅ²»´æÔÚ£¬µÇÂ¼Ê§°Ü
		pConnector->RunScript(0,"LoginFail",pAccount,1);
		return;
	}
	if (password != pAccount->GetPassword())
	{
		//ÃÜÂë´íÎó£¬µÇÂ¼Ê§°Ü
		pConnector->RunScript(0,"LoginFail",pAccount,2);
		return;
	}

	pAccount->SetConnect(pConnector);
	pConnector->SetAccount(strAccount);
	pConnector->RunScript(0,"LoginSuccess",pAccount);
	pConnector->SetScriptLimit("Talk",1);
}

void Talk(string strContent, Connector pConnector)
{

	if (strContent != "")
	{
		CArray AccountArray = GetVal4Data("Data","Account");
		if (CheckClassPoint(AccountArray))
		{
			CAccount pMainAccount = AccountArray->GetVal(pConnector->GetAccount());
			int i = 0;
			while (i < AccountArray->GetSize())
			{
				CAccount pAccount = AccountArray->GetValByIndex(i);
				if (CheckClassPoint(pAccount))
				{
					Connector pAccClient = pAccount->GetConnect();
					if (CheckClassPoint(pAccClient))
					{
						pAccClient->RunScript(0,"SendMessage",pMainAccount,strContent);
					}
				}
				i = i + 1;
			}
		}
	}
}
void main()
{
	//³õÊ¼»¯Êý¾Ý
	CData pData = GetData("Data");

	SetListenPort(9999,"InitConnector");
	print("Æô¶¯Íê³É");
}